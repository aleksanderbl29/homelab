name: Portainer and Traefik Deployment
on:
  workflow_dispatch:
  push:
    branches:
      - 'main'
    paths:
      - 'portainer-traefik/**'
      - 'traefik/**'
      - '.github/workflows/selfhost-deploy.yml'

jobs:
  GitPull:
    runs-on: self-hosted
    steps:
      - name: Update local git
        shell: sh
        run: |
          cd /home/aleksanderbang-larsen/homelab
          git pull
  RedeployStack:
    runs-on: self-hosted
    needs: GitPull
    steps:
      - name: Deploy Portainer
        shell: sh
        run: |
          cd
          cd /home/aleksanderbang-larsen/homelab/portainer-traefik
          docker-compose up -d --force-recreate
      - name: Check DNS
        shell: sh
        run: |
          nslookup traefik-dashboard.local.aleksanderbl.dk 127.0.0.1